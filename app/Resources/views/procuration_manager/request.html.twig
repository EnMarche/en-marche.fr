{% extends 'procuration_manager/_layout.html.twig' %}

{% block procuration_manager_content %}
    <div class="text--summary b__nudge--bottom-large">
        <a href="{{ path('app_procuration_manager_index') }}" class="back-to-list icon--with-text">
            {{ include('components/caret--left.html.twig') }}
            Retour à la liste
        </a>
    </div>

    <h3 class="b__nudge--bottom-large">
        Demande de procuration n°{{ request.id }}

        {% if request.hasFoundProxy %}
            <a href="{{ path('app_procuration_manager_request_deassociate', {'id': request.id}) }}"
               class="btn btn--small procuration-manager__request__process">
                Désassocier de {{ request.foundProxy.firstNames }} {{ request.foundProxy.lastName }}
            </a>
        {% elseif request.processed %}
            <a href="{{ path('app_procuration_manager_request_transform', {'id': request.id, 'action': 'detraiter', 'token': csrfToken}) }}"
               class="btn btn--small procuration-manager__request__process">
                Marquer "En attente"
            </a>
        {% else %}
            <a href="{{ path('app_procuration_manager_request_transform', {'id': request.id, 'action': 'traiter', 'token': csrfToken}) }}"
               class="btn btn--small procuration-manager__request__process">
                Marquer "Traitée manuellement"
            </a>
        {% endif %}
    </h3>

    <hr />

    <div class="l__row l__tablet--col l__row--v-stretch b__nudge--bottom-60 procuration-manager__request">
        <div class="procuration-manager__request__col-left">
            <h4 class="b__nudge--bottom">
                {% if request.processedAt %}
                    Demande traitée le {{ request.processedAt|date('d/m/Y à H:i') }}
                {% else %}
                    Demande en attente
                {% endif %}
            </h4>

            <div class="profile-label">
                Auteur
            </div>
            <div class="profile-value">
                {{ request.gender == 'male' ? 'Monsieur' : 'Madame' }}
                {{ request.firstNames }} {{ request.lastName }}
            </div>

            <div class="profile-label">
                Coordonnées
            </div>
            <div class="profile-value">
                Email :
                <a href="mailto:{{ request.emailAddress }}">
                    {{ request.emailAddress }}
                </a>
                {% if request.phone %}
                <br />
                Téléphone :
                <a href="tel:{{ request.phone|phone_number_format(constant('\\libphonenumber\\PhoneNumberFormat::RFC3966')) }}">
                    {{ request.phone|phone_number_format }}
                </a>
                {% endif %}
            </div>

            <div class="profile-label">
                Date de naissance
            </div>
            <div class="profile-value">
                {{ request.birthdate|date('d/m/Y') }}
            </div>

            <div class="profile-label">
                Lieu de vote
            </div>
            <div class="profile-value">
                {{ request.votePostalCode }} {{ request.voteCityName }} {{ request.voteCountry }}
                {% if request.voteOffice %}
                    <br />
                    Bureau : {{ request.voteOffice }}
                {% endif %}
            </div>

            <div class="profile-label">
                Lieu de résidence
            </div>
            <div class="profile-value">
                {{ request.address }}<br />
                {{ request.postalCode }} {{ request.cityName }} {{ request.country }}
            </div>

            <div class="profile-label">
                Scrutins concernés
            </div>
            <div class="profile-value">
                {% if request.electionPresidentialFirstRound and request.electionPresidentialSecondRound %}
                    Présidentielle : 1er et 2nd tour<br />
                {% elseif request.electionPresidentialFirstRound %}
                    Présidentielle : 1er tour<br />
                {% elseif request.electionPresidentialSecondRound %}
                    Présidentielle : 2nd tour<br />
                {% endif %}

                {% if request.electionLegislativeFirstRound and request.electionLegislativeSecondRound %}
                    Législatives : 1er et 2nd tour<br />
                {% elseif request.electionLegislativeFirstRound %}
                    Législatives : 1er tour<br />
                {% elseif request.electionLegislativeSecondRound %}
                    Législatives : 2nd tour<br />
                {% endif %}
            </div>

            <div class="profile-label">
                Raison de la demande
            </div>
            <div class="profile-value">
                {% if request.reason == constant('AppBundle\\Entity\\ProcurationRequest::REASON_RESIDENCY') %}
                    En raison de mon lieu de résidence
                {% elseif request.reason == constant('AppBundle\\Entity\\ProcurationRequest::REASON_HOLIDAYS') %}
                    Vacances
                {% elseif request.reason == constant('AppBundle\\Entity\\ProcurationRequest::REASON_PROFESIONNAL') %}
                    Obligations professionnelles
                {% elseif request.reason == constant('AppBundle\\Entity\\ProcurationRequest::REASON_HANDICAP') %}
                    En raison d'un handicap
                {% elseif request.reason == constant('AppBundle\\Entity\\ProcurationRequest::REASON_HEALTH') %}
                    Pour raison de santé
                {% elseif request.reason == constant('AppBundle\\Entity\\ProcurationRequest::REASON_HELP') %}
                    Assistance apportée à une personne
                {% elseif request.reason == constant('AppBundle\\Entity\\ProcurationRequest::REASON_TRAINING') %}
                    Obligations de formation
                {% endif %}
            </div>
        </div>

        <div class="procuration-manager__request__col-right">
            {% if request.processedAt %}
                {% if not request.hasFoundProxy %}
                    <h4 class="b__nudge--bottom">
                        Demande traitée manuellement
                    </h4>
                {% else %}
                    <h4 class="b__nudge--bottom">
                        Demande associée à {{ request.foundProxy.firstNames }} {{ request.foundProxy.lastName }}
                    </h4>

                    <div class="profile-label">
                        Auteur
                    </div>
                    <div class="profile-value">
                        {{ request.foundProxy.gender == 'male' ? 'Monsieur' : 'Madame' }}
                        {{ request.foundProxy.firstNames }} {{ request.foundProxy.lastName }}
                    </div>

                    <div class="profile-label">
                        Coordonnées
                    </div>
                    <div class="profile-value">
                        Email :
                        <a href="mailto:{{ request.foundProxy.emailAddress }}">
                            {{ request.foundProxy.emailAddress }}
                        </a>
                        {% if request.foundProxy.phone %}
                            <br />
                            Téléphone :
                            <a href="tel:{{ request.foundProxy.phone|phone_number_format(constant('\\libphonenumber\\PhoneNumberFormat::RFC3966')) }}">
                                {{ request.foundProxy.phone|phone_number_format }}
                            </a>
                        {% endif %}
                    </div>

                    <div class="profile-label">
                        Date de naissance
                    </div>
                    <div class="profile-value">
                        {{ request.foundProxy.birthdate|date('d/m/Y') }}
                    </div>

                    <div class="profile-label">
                        Lieu de vote
                    </div>
                    <div class="profile-value">
                        {{ request.foundProxy.votePostalCode }} {{ request.foundProxy.voteCityName }} {{ request.foundProxy.voteCountry }}
                        {% if request.foundProxy.voteOffice %}
                            <br />
                            Bureau : {{ request.foundProxy.voteOffice }}
                        {% endif %}
                    </div>

                    <div class="profile-label">
                        Lieu de résidence
                    </div>
                    <div class="profile-value">
                        {{ request.foundProxy.address }}<br />
                        {{ request.foundProxy.postalCode }} {{ request.foundProxy.cityName }} {{ request.foundProxy.country }}
                    </div>

                    <div class="profile-label">
                        Disponibilités
                    </div>
                    <div class="profile-value">
                        {% if request.foundProxy.electionPresidentialFirstRound and request.foundProxy.electionPresidentialSecondRound %}
                            Présidentielle : 1er et 2nd tour<br />
                        {% elseif request.foundProxy.electionPresidentialFirstRound %}
                            Présidentielle : 1er tour<br />
                        {% elseif request.foundProxy.electionPresidentialSecondRound %}
                            Présidentielle : 2nd tour<br />
                        {% endif %}

                        {% if request.foundProxy.electionLegislativeFirstRound and request.foundProxy.electionLegislativeSecondRound %}
                            Législatives : 1er et 2nd tour<br />
                        {% elseif request.foundProxy.electionLegislativeFirstRound %}
                            Législatives : 1er tour<br />
                        {% elseif request.foundProxy.electionLegislativeSecondRound %}
                            Législatives : 2nd tour<br />
                        {% endif %}
                    </div>
                {% endif %}
            {% else %}
                <h4 class="b__nudge--bottom">
                    Mandataires trouvés dans la même commune
                </h4>

                {% if matchingProxies|length  == 0 %}
                    <div class="text--body b__nudge--bottom-large">
                        Aucun mandataire trouvé pour cette demande.
                    </div>
                {% else %}
                    <div class="text--body b__nudge--bottom-large">
                        {% if matchingProxies|length == 1 %}
                            1 mandataire semble correspondre à cette demande.<br />
                            N'hésitez pas à le contacter pour confirmer ses disponibilités.
                        {% else %}
                            {{ matchingProxies|length }} mandataires semblent correspondre à cette demande.<br />
                            N'hésitez pas à les contacter pour confirmer leurs disponibilités.
                        {% endif %}
                    </div>

                    <table class="datagrid__table datagrid__table--bordered-rows">
                        <thead>
                        <tr>
                            <th>Score</th>
                            <th class="datagrid__table__col--left " colspan="2">Mandataire</th>
                            <th></th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for proxy in matchingProxies %}
                            {% set score = proxy.score %}
                            {% set proxy = proxy.data %}

                            <tr>
                                <td>{{ score }}</td>
                                <td class="datagrid__table__col--left datagrid__table__col--top">
                                    <strong>{{ proxy.firstNames }} {{ proxy.lastName }}</strong>
                                    <br />
                                    <em>Email :</em>
                                    <a href="mailto:{{ proxy.emailAddress }}">
                                        {{ proxy.emailAddress }}
                                    </a>
                                    {% if proxy.phone %}
                                    <br />
                                    <em>Téléphone :</em>
                                    <a href="tel:{{ proxy.phone|phone_number_format(constant('\\libphonenumber\\PhoneNumberFormat::RFC3966')) }}">
                                        {{ proxy.phone|phone_number_format }}
                                    </a>
                                    {% endif %}
                                    <br />
                                    <em>Disponibilités :</em><br />
                                    {% if proxy.electionPresidentialFirstRound and proxy.electionPresidentialSecondRound %}
                                        Présidentielle : 1er et 2nd tour<br />
                                    {% elseif proxy.electionPresidentialFirstRound %}
                                        Présidentielle : 1er tour<br />
                                    {% elseif proxy.electionPresidentialSecondRound %}
                                        Présidentielle : 2nd tour<br />
                                    {% endif %}

                                    {% if proxy.electionLegislativeFirstRound and proxy.electionLegislativeSecondRound %}
                                        Législatives : 1er et 2nd tour<br />
                                    {% elseif proxy.electionLegislativeFirstRound %}
                                        Législatives : 1er tour<br />
                                    {% elseif proxy.electionLegislativeSecondRound %}
                                        Législatives : 2nd tour<br />
                                    {% endif %}
                                </td>
                                <td class="datagrid__table__col--left">
                                    <br />
                                    <em>Lieu de vote :</em><br />
                                    {{ proxy.votePostalCode }} {{ proxy.voteCityName }}, {{ proxy.voteCountry }}
                                    {% if proxy.voteOffice %}
                                        <br />(bureau : {{ proxy.voteOffice }})
                                    {% endif %}
                                    <br />
                                    <em>Lieu de résidence :</em><br />
                                    {{ proxy.address }}, {{ proxy.postalCode }} {{ proxy.cityName }}, {{ proxy.country }}
                                </td>
                                <td>
                                    <a href="{{ path('app_procuration_manager_request_associate', {'id': request.id, 'proxyId': proxy.id}) }}">
                                        Associer
                                    </a>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                {% endif %}
            {% endif %}
        </div>
    </div>
{% endblock %}
